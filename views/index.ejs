<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Typing Game</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="centering" id="loginPage">
        <h1>Name:</h1>
        <form onsubmit="register(event)">
            <input id="usernameInput" placeholder="Username" required />
            <button type="submit">Join</button>
        </form>
    </div>

    <div class="centering" id="lobbyPage" style="display:none;">
        <h1>Lobby</h1>
        <h3>Players:</h3>
        <ul id="playerList"></ul>
        <label>Time per round (seconds):</label>
        <input id="timeInput" type="number" min="1" value="30" onchange="updateTime()" />
        <br>
        <button onclick="startGame()">Start Game</button>
    </div>

    <div class="centering" id="gamePage" style="display:none;">
        <h1>Typing Round <span id="roundInfo"></span></h1>
        <p id="prevSentence"></p>
        <textarea name="sentenceInput" id="sentenceInput" style="display:block;" autocomplete="off" autocorrect="off" spellcheck="false"></textarea>
        <button id="sentenceButton" onclick="submitSentence()" style="display:block;">Submit</button>
        <p id="waitingMessage" style="display:none;">Waiting for other players...</p>
        <div id="timer"></div>
    </div>

    <div class="centering" id="resultPage" style="display:none;">
        <h1>Final Story</h1>
        <ul id="resultList"></ul>
        <button onclick="location.reload()">Play Again</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();

        function register(event) {
            event.preventDefault();
            const username = document.getElementById('usernameInput').value;
            socket.emit('register', username);
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('lobbyPage').style.display = 'flex';
        }

        function updateTime() {
            const time = document.getElementById('timeInput').value;
            socket.emit('setTime', time);
        }

        function startGame() {
            socket.emit('startGame');
        }

        function submitSentence() {
            let sentence = document.getElementById('sentenceInput').value;
            if (sentence.trim() === "") {
                sentence = "<empty>";
            }
            socket.emit('submitSentence', sentence);
            document.getElementById('sentenceInput').value = "";
            document.getElementById('waitingMessage').style.display = 'block'; // Zeigt an, dass du wartest
            document.getElementById('sentenceButton').style.display = 'none';
            document.getElementById('sentenceInput').style.display = 'none';
        }

        socket.on('playersUpdate', (players) => {
            const list = document.getElementById('playerList');
            list.innerHTML = "";
            players.forEach(p => {
                const li = document.createElement('li');
                li.textContent = p;
                list.appendChild(li);
            });
        });

        socket.on('timeUpdate', (time) => {
            document.getElementById('timeInput').value = time;
        });

        socket.on('startGame', () => {
            document.getElementById('lobbyPage').style.display = 'none';
            document.getElementById('gamePage').style.display = 'flex';
        });

        socket.on('newRound', (data) => {
            document.getElementById('roundInfo').textContent = `${data.round}/${data.totalRounds}`;
            document.getElementById('prevSentence').textContent = data.previousSentence || "Start a new story!";
            document.getElementById('waitingMessage').style.display = 'none'; // Verstecke "Warten"-Nachricht, wenn die Runde startet
            document.getElementById('sentenceButton').style.display = 'block';
            document.getElementById('sentenceInput').style.display = 'block';
        });

        socket.on("timerUpdate", (time) => {
            const timerElement = document.getElementById("timer");
            const seconds = Math.floor(time / 1000);
            const seconds_left = seconds % 60;
            console.log(seconds_left)
            if (seconds_left < 2) {
                submitSentence();
            }
            timerElement.textContent = `Time left: ${seconds_left-1}`;
        });

        socket.on('showResults', (players) => {
            document.getElementById('gamePage').style.display = 'none';
            document.getElementById('resultPage').style.display = 'flex';
            const list = document.getElementById('resultList');
            list.innerHTML = "";

            Object.values(players).forEach(storyList => {
                const container = document.createElement('div');
                container.classList.add('story-container');
                container.style.border = "1px solid black";
                container.style.margin = "10px";
                container.style.padding = "10px";
                

                storyList.forEach(entry => {
                    const p = document.createElement('p');
                    p.textContent = `${entry.name}: ${entry.story}`;
                    container.appendChild(p);
                });

                list.appendChild(container);
            });
        });

    </script>
</body>
</html>
